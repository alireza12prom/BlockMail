services:
  # Local Hardhat blockchain; reachable at localhost:8545 when running
  blockchain:
    build:
      context: ./packages/contracts
      dockerfile: Dockerfile
    ports:
      - "8545:8545"
    command: ["npx", "hardhat", "node", "--hostname", "0.0.0.0"]

  # One-off: deploy BlockMail to the blockchain once it is ready
  deploy:
    build:
      context: ./packages/contracts
      dockerfile: Dockerfile
    environment:
      ETH_RPC_URL: http://blockchain:8545
    command: ["sh", "scripts/wait-and-deploy.sh"]
    depends_on:
      blockchain:
        condition: service_started

  # Build the Electron app (Linux .deb, .rpm, etc.). Artifacts go to packages/app/out/
  # Run: docker compose run --rm app-build
  app-build:
    build:
      context: ./packages/app
      dockerfile: Dockerfile
    volumes:
      - ./packages/app/out:/app/out
    command: ["xvfb-run", "--auto-servernum", "npm", "run", "make"]
